{% comment %}
=========================================================
SECTION: Lookbook Product Grid – Quick Shop
AUTHOR: Production-safe Shopify implementation
FEATURES:
- White background with margins
- Section heading
- Product image grid
- Lookbook-style "+" trigger
- Fully working Quick Shop modal
- Product image, title, description
- Color & Size variants
- Variant-aware Add to Cart
- Vanilla JS only
- Fully responsive
- Theme Editor safe
=========================================================
{% endcomment %}

<section
  id="lookbook-quickshop-{{ section.id }}"
  class="lookbook-section"
>

  <!-- ================= SECTION CONTAINER ================= -->
  <div class="lookbook-container">

    <!-- ================= SECTION HEADING ================= -->
    {% if section.settings.heading != blank %}
      <h2 class="lookbook-heading">
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <!-- ================= PRODUCT GRID ================= -->
    <div class="lookbook-grid">

      {% for block in section.blocks %}
        {% assign product = block.settings.product %}

        {% if product != blank %}
          {% assign image = product.featured_image %}

          <div class="lookbook-item" {{ block.shopify_attributes }}>

            <!-- Product Image -->
            <img
              src="{{ image | image_url: width: 800 }}"
              width="{{ image.width }}"
              height="{{ image.height }}"
              alt="{{ image.alt | escape }}"
              loading="lazy"
            >

            <!-- Lookbook Trigger Button -->
            <button
              type="button"
              class="lookbook-trigger"
              aria-label="Quick shop {{ product.title }}"
              data-title="{{ product.title | escape }}"
              data-image="{{ image | image_url: width: 800 }}"
              data-description="{{ product.description | strip_html | escape }}"
              data-variants='{{ product.variants | json }}'
              data-options='{{ product.options | json }}'
            >
              +
            </button>

          </div>
        {% endif %}
      {% endfor %}

    </div>
  </div>

  <!-- ================= QUICK SHOP MODAL ================= -->
  <div class="quickshop-modal" aria-hidden="true">

    <div class="quickshop-overlay"></div>

    <div class="quickshop-content">

      <!-- Close Button -->
      <button
        type="button"
        class="quickshop-close"
        aria-label="Close quick shop"
      >
        ×
      </button>

      <!-- Product Image -->
      <div class="quickshop-image">
        <img
          id="qs-image"
          src=""
          width="600"
          height="800"
          alt=""
        >
      </div>

      <!-- Product Info -->
      <div class="quickshop-info">
        <h3 id="qs-title"></h3>
        <p id="qs-price"></p>
        <p id="qs-description" class="qs-description"></p>

        <!-- COLOR OPTIONS -->
        <div class="qs-options" id="qs-colors"></div>

        <!-- SIZE OPTIONS -->
        <div class="qs-options">
          <select id="qs-sizes" aria-label="Select size">
            <option value="">Choose your size</option>
          </select>
        </div>

        <!-- Add to Cart Form -->
        <form
          method="post"
          action="{{ routes.cart_add_url }}"
          class="quickshop-form"
        >
          <input type="hidden" name="id" id="qs-variant-id">
          <button type="submit" class="quickshop-atc">
            Add to Cart
          </button>
        </form>
      </div>

    </div>
  </div>

</section>

<!-- ================= STYLES ================= -->
<style>
.lookbook-section {
  background: #ffffff;
  margin-top: 90px;
  padding-bottom: 90px;
}

.lookbook-container {
  max-width: 1337px;
  margin: 0 auto;
  padding: 0 20px;
}

.lookbook-heading {
  font-family: 'Lustria', serif;
  font-size: 36px;
  margin-bottom: 30px;
}

.lookbook-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.lookbook-item {
  position: relative;
}

.lookbook-item img {
  width: 100%;
  display: block;
}

.lookbook-trigger {
  position: absolute;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: rgba(248, 248, 248, 0.9);
  border: 1.5px solid #000;
  font-size: 16px;
  cursor: pointer;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.quickshop-modal {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 9999;
}

.quickshop-modal.active {
  display: block;
}

.quickshop-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.5);
}

.quickshop-content {
  position: relative;
  background: #fff;
  max-width: 800px;
  margin: 5vh auto;
  padding: 30px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
}

.quickshop-close {
  position: absolute;
  top: 10px;
  right: 14px;
  font-size: 28px;
  background: none;
  border: none;
  cursor: pointer;
}

.quickshop-atc {
  background: #000;
  color: #fff;
  padding: 14px;
  border: none;
  cursor: pointer;
  width: 100%;
}

.qs-description {
  font-size: 14px;
  margin-bottom: 16px;
}

.qs-options {
  margin-bottom: 16px;
}

.qs-color-btn {
  border: 1px solid #000;
  padding: 10px 14px;
  background: #fff;
  cursor: pointer;
  margin-right: 8px;
}

.qs-color-btn.active {
  background: #000;
  color: #fff;
}

#qs-sizes {
  width: 100%;
  padding: 12px;
  border: 1px solid #000;
}

@media (max-width: 768px) {
  .lookbook-grid {
    grid-template-columns: 1fr;
  }

  .quickshop-content {
    grid-template-columns: 1fr;
  }
}
</style>

<!-- ================= JAVASCRIPT ================= -->
<script>
/* =========================================================
   LOOKBOOK QUICK SHOP — MASTER SCRIPT
   - Variant-aware Quick Shop modal
   - Color & Size selection
   - Conditional Add to Cart bundle logic
   - Vanilla JavaScript only
========================================================= */

document.addEventListener('DOMContentLoaded', () => {

  /* ================= GLOBAL STATE ================= */
  let currentVariants = [];
  let colorIndex = -1;
  let sizeIndex = -1;

  /* Variant ID of Soft Winter Jacket */
  const SOFT_WINTER_JACKET_VARIANT_ID = 9159215710426;

  /* ================= DOM REFERENCES ================= */
  const section = document.querySelector('#lookbook-quickshop-{{ section.id }}');
  if (!section) return;

  const modal        = section.querySelector('.quickshop-modal');
  const overlay      = section.querySelector('.quickshop-overlay');
  const closeBtn     = section.querySelector('.quickshop-close');

  const img          = section.querySelector('#qs-image');
  const title        = section.querySelector('#qs-title');
  const price        = section.querySelector('#qs-price');
  const description  = section.querySelector('#qs-description');

  const variantInput = section.querySelector('#qs-variant-id');
  const colorWrap    = section.querySelector('#qs-colors');
  const sizeSelect   = section.querySelector('#qs-sizes');
  const atcForm      = section.querySelector('.quickshop-form');

  /* ================= UTIL ================= */
  function formatMoney(cents) {
    return (cents / 100).toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD'
    });
  }

  /* =========================================================
     OPEN QUICK SHOP MODAL
  ========================================================= */
  section.querySelectorAll('.lookbook-trigger').forEach(trigger => {
    trigger.addEventListener('click', () => {

      /* ---------- LOAD PRODUCT DATA ---------- */
      currentVariants = JSON.parse(trigger.dataset.variants);
      const options   = JSON.parse(trigger.dataset.options);

      colorIndex = options.indexOf('Color');
      sizeIndex  = options.indexOf('Size');

      /* ---------- RESET UI ---------- */
      colorWrap.innerHTML = '';
      sizeSelect.innerHTML = '<option value="">Choose your size</option>';

      let selectedColor = null;
      let selectedSize  = null;

      /* ---------- BASIC INFO ---------- */
      img.src = trigger.dataset.image;
      title.textContent = trigger.dataset.title;
      description.textContent = trigger.dataset.description;
      price.textContent = formatMoney(currentVariants[0].price);
      variantInput.value = currentVariants[0].id;

      /* ---------- COLOR OPTIONS ---------- */
      if (colorIndex !== -1) {
        [...new Set(currentVariants.map(v => v.options[colorIndex]))].forEach(color => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'qs-color-btn';
          btn.textContent = color;

          btn.addEventListener('click', () => {
            section.querySelectorAll('.qs-color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedColor = color;
            updateVariant();
          });

          colorWrap.appendChild(btn);
        });
      }

      /* ---------- SIZE OPTIONS ---------- */
      if (sizeIndex !== -1) {
        [...new Set(currentVariants.map(v => v.options[sizeIndex]))].forEach(size => {
          const opt = document.createElement('option');
          opt.value = size;
          opt.textContent = size;
          sizeSelect.appendChild(opt);
        });

        sizeSelect.onchange = e => {
          selectedSize = e.target.value;
          updateVariant();
        };
      }

      /* ---------- VARIANT MATCHING ---------- */
      function updateVariant() {
        const match = currentVariants.find(v =>
          (!selectedColor || v.options[colorIndex] === selectedColor) &&
          (!selectedSize  || v.options[sizeIndex]  === selectedSize)
        );

        if (match) {
          variantInput.value = match.id;
          price.textContent = formatMoney(match.price);
        }
      }

      /* ---------- SHOW MODAL ---------- */
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
    });
  });

  /* =========================================================
     CLOSE MODAL
  ========================================================= */
  [overlay, closeBtn].forEach(el => {
    el.addEventListener('click', () => {
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
    });
  });

  /* =========================================================
     ADD TO CART OVERRIDE — CONDITIONAL BUNDLE
     RULE:
     If Color = Black AND Size = Medium
     → Auto add Soft Winter Jacket
  ========================================================= */
  if (atcForm) {
    atcForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const selectedVariantId = parseInt(variantInput.value, 10);
      if (!selectedVariantId) return;

      const selectedVariant = currentVariants.find(v => v.id === selectedVariantId);
      if (!selectedVariant) return;

      const selectedColor = colorIndex !== -1 ? selectedVariant.options[colorIndex] : null;
      const selectedSize  = sizeIndex  !== -1 ? selectedVariant.options[sizeIndex]  : null;

      /* ---------- CART ITEMS ---------- */
      const items = [
        { id: selectedVariantId, quantity: 1 }
      ];

      if (selectedColor === 'Black' && selectedSize === 'Medium') {
        items.push({
          id: SOFT_WINTER_JACKET_VARIANT_ID,
          quantity: 1
        });
      }

      /* ---------- AJAX ADD ---------- */
      try {
        await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ items })
        });

        window.location.href = '/cart';

      } catch (err) {
        console.error('Add to cart error:', err);
      }
    });
  }

});
</script>


{% schema %}
{
  "name": "Lookbook – Quick Shop",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Tisso vison in the wild"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product Item",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Lookbook – Quick Shop",
      "blocks": [
        { "type": "product" },
        { "type": "product" },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}
