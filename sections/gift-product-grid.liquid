{% comment %}
=========================================================
SECTION: Product Grid with Quick Shop Modal
PURPOSE:
- Display selectable products
- Lookbook-style Quick Shop popup
- Fully vanilla JS
- Proper image attributes (width, height, alt)
- Functional Add to Cart
=========================================================
{% endcomment %}

<section class="product-grid" id="product-grid-{{ section.id }}">

  <!-- ================= PRODUCT GRID ================= -->
  <div class="grid-wrapper">

    {% for block in section.blocks %}
      {% assign product = block.settings.product %}

      {% if product %}
        <div class="product-card">

          <!-- Product Image -->
          <img
            src="{{ product.featured_image | image_url: width: 600 }}"
            width="600"
            height="750"
            alt="{{ product.title | escape }}"
            loading="lazy">

          <!-- Quick Shop Trigger -->
          <button
            class="quick-shop-trigger"
            aria-label="Quick shop {{ product.title }}"
            data-handle="{{ product.handle }}"
            data-image="{{ product.featured_image | image_url: width: 800 }}"
            data-title="{{ product.title | escape }}"
            data-price="{{ product.price | money }}"
            data-description="{{ product.description | strip_html | escape }}">
            +
          </button>

        </div>
      {% endif %}
    {% endfor %}

  </div>

  <!-- ================= QUICK SHOP MODAL ================= -->
  <div class="quickshop-modal" aria-hidden="true">

    <div class="modal-overlay"></div>

    <div class="modal-content">

      <!-- Close Button -->
      <button class="modal-close" aria-label="Close popup">Ã—</button>

      <!-- Product Image -->
      <img
        class="modal-image"
        src=""
        width="800"
        height="1000"
        alt=""
        loading="lazy">

      <!-- Product Info -->
      <div class="modal-info">
        <h2 class="modal-title"></h2>
        <p class="modal-price"></p>
        <p class="modal-description"></p>

        <!-- Add to Cart -->
        <form method="post" action="/cart/add" class="modal-form">
          <input type="hidden" name="id" class="variant-id">
          <button type="submit" class="btn add-to-cart">
            Add to Cart
          </button>
        </form>
      </div>

    </div>
  </div>

</section>

<!-- ================= STYLES ================= -->
<style>
/* ---------- GRID ---------- */
.grid-wrapper {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 30px;
}

.product-card {
  position: relative;
}

.product-card img {
  width: 100%;
  height: auto;
  display: block;
}

/* ---------- QUICK SHOP BUTTON ---------- */
.quick-shop-trigger {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: #fff544;
  color: #000;
  font-size: 22px;
  cursor: pointer;
}

/* ---------- MODAL ---------- */
.quickshop-modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 999;
}

.quickshop-modal.active {
  display: block;
}

.modal-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.6);
}

.modal-content {
  position: relative;
  max-width: 900px;
  margin: 5vh auto;
  background: #fff;
  display: grid;
  grid-template-columns: 1fr 1fr;
}

.modal-image {
  width: 100%;
  height: auto;
}

.modal-info {
  padding: 40px;
}

.modal-close {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 26px;
  background: none;
  border: none;
  cursor: pointer;
}

/* ---------- MOBILE ---------- */
@media (max-width: 768px) {
  .grid-wrapper {
    grid-template-columns: 1fr;
  }

  .modal-content {
    grid-template-columns: 1fr;
  }
}
</style>

<!-- ================= VANILLA JS ================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {

  const modal = document.querySelector('#product-grid-{{ section.id }} .quickshop-modal');
  const image = modal.querySelector('.modal-image');
  const title = modal.querySelector('.modal-title');
  const price = modal.querySelector('.modal-price');
  const description = modal.querySelector('.modal-description');
  const variantInput = modal.querySelector('.variant-id');

  // Open modal
  document.querySelectorAll('#product-grid-{{ section.id }} .quick-shop-trigger')
    .forEach(button => {
      button.addEventListener('click', async () => {

        image.src = button.dataset.image;
        image.alt = button.dataset.title;
        title.textContent = button.dataset.title;
        price.textContent = button.dataset.price;
        description.textContent = button.dataset.description;

        // Fetch first variant ID
        const response = await fetch(`/products/${button.dataset.handle}.js`);
        const productData = await response.json();
        variantInput.value = productData.variants[0].id;

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
      });
    });

  // Close modal
  modal.querySelector('.modal-close').addEventListener('click', closeModal);
  modal.querySelector('.modal-overlay').addEventListener('click', closeModal);

  function closeModal() {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
  }

});
</script>

{% schema %}
{
  "name": "Product Grid Quick Shop",
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Grid with Quick Shop",
      "blocks": [
        { "type": "product" },
        { "type": "product" },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}
